language: python
python:
  - "2.7"
addons:
  - postgresql: "9.3"
services:
  - elasticsearch
before_install:
  - sudo apt-get install -qq zlib1g-dev
  - npm install -g grunt-cli
install:
  - pip install -r requirements/test.txt
  - npm install -g cssmin uglify-js
  - npm install -g casperjs
  - cd src
  - npm install
before_script:
  - psql -c "CREATE USER phase WITH PASSWORD 'phase';" -U postgres
  - psql -c 'CREATE DATABASE phase_test;' -U postgres
  - psql -c 'GRANT ALL PRIVILEGES ON DATABASE phase_test to phase;' -U postgres
  - psql -c 'CREATE DATABASE test_phase_test;' -U postgres
  - psql -c 'GRANT ALL PRIVILEGES ON DATABASE test_phase_test to phase;' -U postgres
script:
  - export DJANGO_SETTINGS_MODULE=core.settings.test
  - grunt
  - flake8 --exclude=migrations,docs,urls.py,bootstrap/bootstrap-src --ignore=E501 .
  - python manage.py collectstatic --noinput
  - coverage run --source='.' manage.py test --noinput
after_success:
  - coveralls
notifications:
  - recipients:
    - thibault@jouannic.fr
  - on_success: change
  - on_failure: always
